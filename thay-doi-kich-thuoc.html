<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    .rs-widget-card {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        max-width: 650px;
        margin: 40px auto;
        border: 1px solid #e0e0e0;
        overflow: hidden;
    }
    .rs-header {
        background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%); /* M√†u xanh d∆∞∆°ng hi·ªán ƒë·∫°i */
        color: white; padding: 25px; text-align: center;
    }
    .rs-header h3 { margin: 0; font-size: 1.6rem; font-weight: 700; }
    
    .rs-body { padding: 30px; }
    .rs-section { margin-bottom: 30px; }
    .rs-label-title { display: block; font-weight: 700; margin-bottom: 12px; color: #333; font-size: 1.1rem; }

    /* BUTTON GROUP CHO UPLOAD */
    .rs-upload-group { display: flex; gap: 15px; }
    
    .rs-upload-btn-wrapper {
        flex: 1; position: relative; overflow: hidden;
        border: 2px dashed #0083b0; border-radius: 10px;
        background: #f0f8ff; color: #0083b0;
        padding: 20px 10px; text-align: center; cursor: pointer;
        transition: all 0.3s; font-weight: 600;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .rs-upload-btn-wrapper:hover { background: #e0f2ff; transform: translateY(-2px); }
    
    .rs-upload-btn-wrapper input[type=file] {
        position: absolute; left: 0; top: 0; opacity: 0;
        cursor: pointer; height: 100%; width: 100%;
    }
    .rs-icon { font-size: 24px; margin-bottom: 5px; display: block;}

    /* List file */
    .rs-file-status {
        margin-top: 15px; padding: 10px; background: #f1f3f4; border-radius: 8px;
        color: #555; font-size: 0.95rem; display: none; border-left: 4px solid #0083b0;
    }

    /* Controls */
    .rs-controls-box { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef; }
    .rs-input-styled {
        width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;
        box-sizing: border-box;
    }
    
    /* Progress Bar */
    .rs-progress-container {
        display: none; margin-top: 20px; background: #eee; border-radius: 20px; height: 20px; overflow: hidden;
    }
    .rs-progress-bar { height: 100%; width: 0%; background: #28a745; transition: width 0.3s; }
    .rs-status-text { text-align: center; margin-top: 5px; font-size: 0.9rem; color: #666; display: none;}

    /* Download Button */
    .rs-btn-download {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        color: white; border: none; padding: 16px; border-radius: 50px;
        cursor: pointer; font-size: 18px; font-weight: 700; width: 100%;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); margin-top: 20px;
    }
    .rs-btn-download:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; opacity: 0.7;}
</style>

<div class="rs-widget-card">
    <div class="rs-header">
        <h3>üìÇ Resize ·∫¢nh ƒêa NƒÉng</h3>
        <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">H·ªó tr·ª£ t·∫£i Folder & N√©n ZIP t·ª± ƒë·ªông</p>
    </div>

    <div class="rs-body">
        <div class="rs-section">
            <label class="rs-label-title">1. Ch·ªçn ngu·ªìn ·∫£nh:</label>
            
            <div class="rs-upload-group">
                <div class="rs-upload-btn-wrapper">
                    <span class="rs-icon">üìÑ</span>
                    <span>Ch·ªçn nhi·ªÅu File</span>
                    <input type="file" id="rs-fileInput" accept="image/*" multiple>
                </div>

                <div class="rs-upload-btn-wrapper">
                    <span class="rs-icon">üìÅ</span>
                    <span>Ch·ªçn c·∫£ Folder</span>
                    <input type="file" id="rs-folderInput" webkitdirectory directory multiple>
                </div>
            </div>

            <div id="rs-statusDisplay" class="rs-file-status"></div>
        </div>

        <div class="rs-section">
            <label class="rs-label-title">2. C·∫•u h√¨nh k√≠ch th∆∞·ªõc:</label>
            <div class="rs-controls-box">
                <p style="margin-top:0; font-size: 0.9rem; color: #555;">
                    üí° H·ªá th·ªëng s·∫Ω t·ª± t√≠nh chi·ªÅu cao ƒë·ªÉ ·∫£nh kh√¥ng b·ªã m√©o.
                </p>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label>Chi·ªÅu ngang m·ªõi (X) - px</label>
                        <input type="number" id="rs-inputX" class="rs-input-styled" placeholder="V√≠ d·ª•: 1200">
                    </div>
                </div>
            </div>
        </div>

        <div class="rs-progress-container" id="rs-progressContainer">
            <div class="rs-progress-bar" id="rs-progressBar"></div>
        </div>
        <p class="rs-status-text" id="rs-statusText">ƒêang x·ª≠ l√Ω...</p>

        <button id="rs-downloadBtn" class="rs-btn-download" disabled>
            ‚ö° B·∫Øt ƒë·∫ßu Resize & T·∫£i ZIP
        </button>
    </div>
    <canvas id="rs-canvas" style="display: none;"></canvas>
</div>

<script>
(function() {
    // Khai b√°o bi·∫øn
    const fileInput = document.getElementById('rs-fileInput');
    const folderInput = document.getElementById('rs-folderInput');
    const statusDisplay = document.getElementById('rs-statusDisplay');
    const inputX = document.getElementById('rs-inputX');
    const downloadBtn = document.getElementById('rs-downloadBtn');
    const progressBar = document.getElementById('rs-progressBar');
    const progressContainer = document.getElementById('rs-progressContainer');
    const statusText = document.getElementById('rs-statusText');
    const canvas = document.getElementById('rs-canvas');
    const ctx = canvas.getContext('2d');

    let selectedFiles = [];

    // H√†m x·ª≠ l√Ω chung khi nh·∫≠n file (t·ª´ file input ho·∫∑c folder input)
    function handleFilesSelection(files) {
        // L·ªçc ch·ªâ l·∫•y file ·∫£nh (v√¨ folder c√≥ th·ªÉ ch·ª©a file r√°c .ds_store, .txt...)
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

        if (imageFiles.length > 0) {
            selectedFiles = imageFiles;
            statusDisplay.style.display = 'block';
            statusDisplay.innerHTML = `‚úÖ <b>ƒê√£ nh·∫≠n:</b> ${selectedFiles.length} file ·∫£nh.<br><small>S·∫µn s√†ng ƒë·ªÉ x·ª≠ l√Ω.</small>`;
            downloadBtn.disabled = false;
        } else {
            statusDisplay.style.display = 'block';
            statusDisplay.innerHTML = `‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y file ·∫£nh n√†o trong l·ª±a ch·ªçn n√†y.`;
            downloadBtn.disabled = true;
        }
    }

    // 1. S·ª± ki·ªán ch·ªçn File l·∫ª
    fileInput.addEventListener('change', function(e) {
        handleFilesSelection(e.target.files);
        folderInput.value = ''; // Reset input kia
    });

    // 2. S·ª± ki·ªán ch·ªçn Folder
    folderInput.addEventListener('change', function(e) {
        handleFilesSelection(e.target.files);
        fileInput.value = ''; // Reset input kia
    });

    // 3. X·ª≠ l√Ω ch√≠nh (Batch Processing)
    downloadBtn.addEventListener('click', async function() {
        const targetWidth = parseInt(inputX.value);
        if (!targetWidth || targetWidth <= 0) {
            alert("Vui l√≤ng nh·∫≠p chi·ªÅu ngang mong mu·ªën!");
            return;
        }

        // Setup UI Loading
        this.disabled = true;
        this.innerHTML = "‚è≥ ƒêang ch·∫°y...";
        progressContainer.style.display = 'block';
        statusText.style.display = 'block';
        
        const zip = new JSZip(); 
        
        // Loop x·ª≠ l√Ω
        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            
            // C·∫≠p nh·∫≠t text & thanh ti·∫øn tr√¨nh
            statusText.textContent = `ƒêang resize: ${file.name} (${i + 1}/${selectedFiles.length})`;
            const percent = ((i + 1) / selectedFiles.length) * 100;
            progressBar.style.width = `${percent}%`;

            try {
                // Resize
                const resizedBlob = await resizeSingleImage(file, targetWidth);
                
                // ƒê·∫∑t t√™n file trong ZIP (gi·ªØ nguy√™n t√™n g·ªëc ho·∫∑c th√™m suffix)
                // L∆∞u √Ω: Folder upload c√≥ th·ªÉ c√≥ ƒë∆∞·ªùng d·∫´n (webkitRelativePath), 
                // ·ªü ƒë√¢y ta ch·ªâ l·∫•y t√™n file cu·ªëi ƒë·ªÉ gom h·∫øt v√†o 1 th∆∞ m·ª•c trong ZIP cho g·ªçn.
                const newName = "resized_" + file.name;
                
                zip.file(newName, resizedBlob);
            } catch (err) {
                console.error("L·ªói v·ªõi file:", file.name, err);
            }
        }

        // N√©n v√† t·∫£i v·ªÅ
        statusText.textContent = "üì¶ ƒêang ƒë√≥ng g√≥i file ZIP...";
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "anh_da_resize_batch.zip");
            
            // Reset UI
            downloadBtn.innerHTML = "‚úÖ Xong! L√†m ti·∫øp ƒë·ª£t kh√°c?";
            downloadBtn.disabled = false;
            statusText.textContent = "ƒê√£ t·∫£i xu·ªëng!";
        });
    });

    // H√†m Resize (Promise)
    function resizeSingleImage(file, targetWidth) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const ratio = img.width / img.height;
                    const targetHeight = Math.round(targetWidth / ratio);

                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    // V·∫Ω ·∫£nh ch·∫•t l∆∞·ª£ng cao
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                    canvas.toBlob(resolve, 'image/jpeg', 0.9);
                };
                img.onerror = reject;
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

})();
</script>
